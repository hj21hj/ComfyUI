<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SD‑Turbo on WebGPU — GitHub Pages (UMD)</title>
  <meta name="description" content="Stable Diffusion Turbo in the browser (WebGPU). UMD-only build for GitHub Pages." />
  <style>
    body{font-family:sans-serif;max-width:900px;margin:40px auto;padding:0 16px;background:#0b0b0c;color:#f6f7fb}
    h1{font-size:24px}
    textarea,input,select,button{width:100%;padding:8px;border-radius:8px;border:1px solid #444;background:#111;color:#f6f7fb}
    button{background:#4aa3ff;color:#001326;font-weight:bold;cursor:pointer}
    canvas{max-width:100%;border:1px solid #333;border-radius:8px;background:#000;margin-top:12px}
    #log{white-space:pre-wrap;font-family:monospace;background:#111;padding:8px;border-radius:8px;border:1px dashed #333;height:200px;overflow:auto;margin-top:12px}
    .row{margin-top:10px}
    .ok{color:#75f0a1}.warn{color:#fbbf24}.err{color:#fb7185}
  </style>
  <!-- Load UMD build directly -->
  <script src="https://cdn.jsdelivr.net/npm/@aislamov/diffusers.js/dist/diffusers.min.js"></script>
</head>
<body>
  <h1>Stable Diffusion Turbo — UMD Only</h1>
  <p>브라우저(WebGPU)에서 직접 실행. 모델은 Hugging Face에서 다운로드되어 캐시에 저장됩니다.</p>
  <div class="row"><label>프롬프트</label><textarea id="prompt" rows="3">a tiny corgi astronaut on the moon</textarea></div>
  <div class="row"><label>steps</label><input id="steps" type="number" value="1" min="1" max="6"></div>
  <div class="row"><label>seed</label><input id="seed" type="number" value="0"></div>
  <div class="row"><label>출력 크기</label>
    <select id="size">
      <option value="512x512" selected>512x512</option>
      <option value="640x640">640x640</option>
      <option value="768x768">768x768</option>
    </select>
  </div>
  <div class="row"><button id="btn-run">이미지 생성</button> <button id="btn-save" disabled>PNG 저장</button></div>
  <canvas id="canvas" width="512" height="512"></canvas>
  <div id="log"></div>

<script>
const { DiffusionPipeline } = window.Diffusers;
const logEl = document.getElementById('log');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const btnRun = document.getElementById('btn-run');
const btnSave = document.getElementById('btn-save');
let pipe = null; let lastImageData = null;

function log(msg,cls=""){const d=document.createElement("div");if(cls)d.className=cls;d.textContent="["+new Date().toLocaleTimeString()+"] "+msg;logEl.prepend(d);}

function parseSize(v){const[w,h]=v.split("x").map(Number);return{width:w,height:h};}

async function ensurePipeline(){
  if(pipe) return pipe;
  log("모델 로드 중...","warn");
  pipe=await DiffusionPipeline.fromPretrained("stabilityai/sd-turbo");
  log("모델 로드 완료","ok");
  return pipe;
}

async function run(){
  btnRun.disabled=true;btnSave.disabled=true;
  try{
    const prompt=document.getElementById("prompt").value.trim();
    const steps=Math.max(1,Math.min(Number(document.getElementById("steps").value)||1,6));
    const seed=Number(document.getElementById("seed").value)||0;
    const {width,height}=parseSize(document.getElementById("size").value);
    canvas.width=width;canvas.height=height;
    const p=await ensurePipeline();
    log("생성 시작... prompt="+prompt);
    const images=await p.run({prompt,numInferenceSteps:steps,seed,width,height});
    const img=images[0];
    const data=await img.toImageData({tensorLayout:"NCWH",format:"RGB"});
    ctx.putImageData(data,0,0);lastImageData=data;
    btnSave.disabled=false;log("완료","ok");
  }catch(e){console.error(e);log("에러: "+(e.message||e),"err");}
  finally{btnRun.disabled=false;}
}

btnRun.addEventListener("click",run);
btnSave.addEventListener("click",()=>{
  if(!lastImageData)return;
  const tmp=document.createElement("canvas");tmp.width=canvas.width;tmp.height=canvas.height;
  tmp.getContext("2d").putImageData(lastImageData,0,0);
  const url=tmp.toDataURL("image/png");const a=document.createElement("a");a.href=url;a.download="sd-turbo.png";a.click();
});
</script>
</body>
</html>
